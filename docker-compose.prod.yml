version: "3.9"

services:
  db:
    image: postgres:16
    container_name: soccerlab_db
    restart: unless-stopped
    env_file: ./backend/.prod.env
    volumes:
      - db_data:/var/lib/postgresql/data
    networks: [internal]

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile.prod
    container_name: soccerlab_backend
    restart: unless-stopped
    env_file: ./backend/.prod.env
    depends_on:
      db:
        condition: service_healthy
    networks: [web, internal]

  frontend-build:             # 빌드용 일시 컨테이너
    build:
      context: ./frontend
      dockerfile: Dockerfile.prod
    container_name: soccerlab_frontend_build
    command: ["echo", "build complete"]   # 실행 후 바로 종료
    networks: [web]

  nginx:
    image: nginx:1.25-alpine
    restart: unless-stopped
    depends_on:
      - backend
      - frontend-build
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/prod.nginx.conf:/etc/nginx/nginx.conf:ro
      - ./frontend/dist:/usr/share/nginx/html:ro   # 정적 파일
    networks: [web]

volumes:
  db_data:

networks:
  web:
  internal:
